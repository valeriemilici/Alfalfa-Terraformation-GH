---
title: "The Alfalfa Small-Pot Experiments: Pore-Water Geochemistry Models"
author: "Valerie Milici"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list =ls())

library(tidyverse) #clean data manipulation
library(lme4) #mixed effects models
library(lmerTest) #p-values from linear mixed models
library(MASS) #for contr.sdif
library(broom.mixed) #model diagnostics
library(performance) #model diagnostics
library(rmarkdown) #to render the document
library(knitr) # for pretty markdown tables
library(car) # for bartlett test
library(stats) #bootstrap
library(parallel) #bootstrap in parallel
library(corrr) #for PCAs
library(ggcorrplot) #PCA
library(FactoMineR) #PCA
library(factoextra) #PCA
library(ggfortify) #PCA 
library(ggeffects) #for quick beautiful plotting

dat <- read.csv("~/Desktop/Alfalfa-Terraformation-GH/Task2A/data/ModData/AllPerformanceGeochem.csv")
```

<a id="toc"></a>

# Table of Contents

 [Introduction](#item-one)
 
 [pH and EC](#item-two)
 
 [Carbon](#item-three)
 
 [Nitrogen](#item-four)
 
 [Cations](#item-five)
 
 [Anions](#item-six)
 
 [PCA](#item-seven)

<a id="item-one"></a>

# Introduction

Below are the models and results of pore-water geochemistry data from the July - October 2022 GCR Task 2A experiment. These models explore broad trends in how the microbes that have naturally colonized the Landscape Evolutionary Observatory (LEO) at Biosphere 2, vascular plants (Alfalfa, *Medicago sativa*), and soil moisture variation affect geochemical weathering during early pedogenesis (measured from pore-water/discharge samples).

The pore-water samples were collected at the end of a discharge experiment that allowed us to calculate the mass balance of water in the pots. In this discharge experiment, 150 ml of DI water were added to the pots and the discharge from this final watering event provided the samples used in this analysis. Because the pots had three different baseline soil saturation levels, there is variation in the amount of discharge resulting from each pot. As a result, total discharge "Dmass_tot" is a fixed effect in all models to account for this variation. Throughout the experiment, the pots were watered such that they never produced discharge, so the pore-water/discharge samples used in these analyses represent the only discharge event. More details on the experimental design and discharge experiment are available in the detailed experimental protocol *insert hyperlink to the protocol at a later date *

*These models will help us to evaluate the following questions:*

1. How do biota, vascular plants and soil microbes, affect geochemical weathering rates?

2. During early pedogenesis do vascular plants or soil microbes have a stronger role in weathering, or is this relationship interactive?

2. and how does abiotic variation (soil moisture) affect these relationships?  

There are four soil treatments in this experiment:

<ins> The Bare Soil Treatments </ins>

1. C = no plants, no microbes

2. N = no plants, microbe inoculation

<ins> The Planted Treatments </ins>

3. L = plants added & microbe inoculation

4. S = plants added without microbe inoculation


*Note*: Models exploring genotype-specific trends can be found in the "Porewater geochemistry: Genotype-Specific" document.

## Set the Model Contrasts

First, I will define how the model interprets soil moisture ("Level"). I am using standard difference contrasts so that the intercept can be interpreted as the "average soil moisture effect"- just like in the case of a sum-to-zero contrast- & the model output will tell us how increased soil moisture affects patterns in microbial effects on plant performance (i.e., level 2 vs level 1 & level 3 vs level 2).

```{r echo=FALSE}

dat <- filter(dat, Soil != "P")

dat$Geno <- dat$Geno %>% replace_na("C")

```


```{r Set Model Contrasts}
dat$Level <- as.factor(dat$Level)
contrasts(dat$Level) <- contr.sdif(3)
```

<a id="item-two"></a>

## pH and EC

Jump to [summary](#summary-one) of models

```{r echo = F}
dat$Soil <- relevel(factor(dat$Soil), 
                     ref = "S")
```

### pH model

```{r pH Soil model selection, include=F }
pHSoil1 <- lmer(pH ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

pHSoil2 <- lmer(pH ~ soil_LSB + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

pHSoil3 <- lmer(pH ~ plant_YN + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

compare_performance(pHSoil1, pHSoil2, pHSoil3, rank = T)
```

Model comparison tells me that the best model separates out the four soil treatments, rather than grouping them by whether or not they had plants or whether or not they had microbes.

```{r pH Soil, echo=F, message=F}
pHSoil <- lmer(pH ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)
```

*check the model diagnostics*

```{r pH Soil diagnostics, echo=F, fig.dim= c(6,8)}
check_model(pHSoil)
```
looks good to me!

```{r pH Soil summary table, echo=F}
pHSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Ok, so we can see that soil moisture does affect porewater pH, which peaks at intermediate soil moisture. We can also see some marginal effects of soil. Treatments N and S have lower pHs than L pots, but this is super marginal. This implies that the presence of plants and microbes together leads to higher weathering (weathering will increase pH in basalt) than just microbes or plant alone, so a potential interaction. If you focus on the std. error around the estimate, you can see that live and sterile soil treatments (aka basalt that contains vascular plants) has a small std. error around the estimate (~ 0.06 in both cases), while both bare soil treatments have large std. error (~ 0.14). The model is struggling to estimate what the pH is for those bare soil treatments, compared to the planted treatments. It may be that plants make some values, such as pH more predictable/deterministic. The [variance tests](#b-testpH) tell us that planted treatments have significantly less variation than bare soil treatments. 

```{r pH plot, message=FALSE, echo=FALSE}

pHpreds <- ggemmeans(pHSoil, terms = "Soil", type = "fixed")

pHpreds$x <- factor(pHpreds$x, c("C", "N", "S", "L"))

# Create Plot

pHplot <- ggplot() +
  geom_pointrange(data = pHpreds,
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  xlab("Soil Biota Treatment") +
  ylab("Porewater pH") +
  scale_x_discrete(labels = c("C" = "Abiotic \n Control", "N" = "Microbes \nOnly",
                              "S" = "Plant \nOnly", "L" = "Plant & \n Microbes")) +
  theme_classic(18)

ggsave(pHplot, filename = "figures/pHSoil.png",
       height = 6, width =8, units = "in")

pHplot

```

```{r save pH model, echo=FALSE}
saveRDS(pHSoil, file = "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/pHSoil.RDS")
```

### EC model

```{r echo = F}
dat$Soil <- relevel(factor(dat$Soil), 
                     ref = "C")
```

```{r EC Soil model selection, include=F }
ECSoil1 <- lmer(log(EC) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

ECSoil2 <- lmer(log(EC) ~ soil_LSB + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

ECSoil3 <- lmer(log(EC) ~ plant_YN + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

compare_performance(ECSoil1, ECSoil2, ECSoil3, rank = T)
```

In the case of EC, the best model only compares whether or not the pots contained a plant, so that is the model form that we will move forward with. 

```{r EC Soil, message = F}
ECSoil <- lmer(log(EC) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)
```

*check the model diagnostics*

```{r EC Soil diagnostics, echo=F, fig.dim= c(6,8)}
check_model(ECSoil)
```
looks good to me!

```{r EC Soil summary table, echo=F}
ECSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

EC also peaks at intermediate soil moisture. Pots that contain plants have marginally higher (*P* = 0.090) EC than pots that contain only bare soil. In this case there doesn't appear to be any difference in standard error between whether or not plants were present, but I will still complete [variance tests](#b-testEC) to compare the effects. 

```{r save EC model, echo=FALSE}
saveRDS(ECSoil, file = "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/ECSoil.RDS")
```


```{r ECplot, message=FALSE, echo=FALSE}
ECpreds <- ggemmeans(ECSoil, terms = "Soil", type = "fixed")

ECpreds$x <- factor(ECpreds$x, c("C", "N", "S", "L"))

# Create Plot

ECplot <- ggplot() +
  geom_pointrange(data = ECpreds,
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  xlab("Soil Biota Treatment") +
  ylab("Electrical Conductivity (EC) ") +
  scale_x_discrete(labels = c("C" = "Abiotic \n Control", "N" = "Microbes \nOnly",
                              "S" = "Plant \nOnly", "L" = "Plant & \n Microbes")) +
  theme_classic(18)

ggsave(ECplot, filename = "figures/ECSoil.png",
       height = 6, width =8, units = "in")

ECplot
```


### Test of Variances
<a id="b-testpH"></a>

```{r echo= F, message=F, include=F}
# Step 1: Generate Predicted Data (remove effect of Level) 
pred.fun3 <- function(mod) {
  model.matrix(~plant_YN,
               data = expand.grid(plant_YN =c("Y", "N"))) %*%
    fixef(mod)[c(1:2)]
}

#Create cluster within computer to bootstrap in parallel
cl <- makeCluster(detectCores()) 
clusterEvalQ(cl, library(lme4))

#create data frame of model predictions for EC and pH in each soil treatment
EC3sims <- bootMer(ECSoil3, FUN = pred.fun3,
                nsim = 1000, parallel = "snow", ncpus = detectCores(),cl = cl)
pH3sims <- bootMer(pHSoil3, FUN = pred.fun3,
                nsim = 1000, parallel = "snow", ncpus = detectCores(),cl = cl)

stopCluster(cl = cl)

#Prepare Data for Bartlett Test
EC3draws <- data.frame(EC3sims$t)
pH3draws <- data.frame(pH3sims$t)
plant <- c("Y", "N")

names(EC3draws) <- plant
names(pH3draws) <- plant
```


### pH Model 

The model predicts that both bare soil treatments (C and N) have much wider error around their estimates than the planted treatments (L and S). Below is a density plot of 1000 model simulated pH values per treatment. You can see that their distributions appear different and we will conduct a Bartlett and F-test test to assess whether they are different. 

```{r plot the density of the pH sims, echo = F}
pHdraws2 <- pivot_longer(pH3draws, cols = Y:N)

densityPlot(pHdraws2$value ~ as.factor(pHdraws2$name),
            legend = list(title = "Treatment"),
            xlab = "Model Estimates of pH")



```

Do planted treatments have less variance than bare treatments for pH?
```{r pH mod bartlett test}
bartlett.test(list(pH3draws$Y, pH3draws$N))
```

yes.
```{r pH mod F test}
var.test(pH3draws$Y, pH3draws$N)
```


### EC model

<a id="b-testEC"></a>

The model predicts that both bare soil treatments (C and N) have much wider error around their estimates than the planted treatments (L and S). For the variable EC, the best supported model only considered whether or not the pot was a bare soil control (with plant = N) or was planted with alfalfa (with plant = Y). Below is a density plot of 1000 model simulated EC values per treatment. You can see that their distributions appear different and we will conduct a Bartlett and F-test test to assess whether they are different. 

```{r plot the density of the EC sims, echo = F}
ECdraws2 <- pivot_longer(EC3draws, cols = Y:N)

densityPlot(exp(ECdraws2$value) ~ as.factor(ECdraws2$name),
            legend = list(title = "Soil Treatment"),
            xlab = "Model Estimates of EC")
```

Do planted treatments have less variance than bare treatments for EC?

```{r EC mod bartlett test}
bartlett.test(list(exp(EC3draws$Y), exp(EC3draws$N)))
```
According to Bartlett test, the variances are different.

```{r EC mod  F-test}
var.test(EC3draws$Y, EC3draws$N)
```
According to F-test the variances are different. 

## Summary of pH and EC

<a id="summary-one"></a>

Both pH and EC peak at intermediate soil moisture and are similar between low and high moisture treatments. We also see that in both cases, biota are associated with marginal increases, which mean that the biota are likely playing a role in soil weathering. In the case of pH, it appears that microbes may drive the increase in pH, because both microbe containing treatments (L and C) had identical mean estimates, but plants help to stabilize this effect (evidenced by reduced variation in pH when both plants and microbes are present). In the case of EC, the patterns were driven by the presence or absence of plants, because accounting for microbe treatment did not improve the model. Here we see that plants increase EC, and we continue to see that plants stabilize the estimates (reduced variation). Thus, the presence of plants makes weathering, as approximated by EC and pH, much more predictable and may help to reduce incongruous weathering patterns.

[Table of Contents](#toc)

<a id="item-three"></a>

## Carbon (TC, IC, OC) 

Jump to [summary](#summary-two) of Carbon models.

### Total Carbon

```{r TC Soil model selection, include=F }

dat$batch_TC <- as.factor(dat$batch_TC)
contrasts(dat$batch_TC) <- contr.sum(3)

TCSoil1 <- lmer(TC_ppm ~ Soil * Level + scale(Dmass_tot) + as.factor(batch_TC) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

TCSoil2 <- lmer(TC_ppm ~ Soil + Level + scale(Dmass_tot) + as.factor(batch_TC) +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

compare_performance(TCSoil1, TCSoil2, rank = T)

anova(TCSoil1)
```

The model that separates the four soil treatments is the best model, and the interaction between soil and level is significant and should remain in the model. 

```{r echo = F}
dat$Soil <- relevel(factor(dat$Soil), 
                     ref = "L")
```

```{r total carbon, message = F}
TCSoil <- lmer(TC_ppm ~ Soil * Level + scale(Dmass_tot) + as.factor(batch_TC) +
                 (1|Geno) + (1|table) + (1|dis_table),
                  data = dat)
```

*check the model diagnostics*

```{r TC Soil diagnostics, echo=F, fig.dim= c(6,8)}
check_model(TCSoil)
```
looks good to me!

```{r TC Soil summary table, echo=F}
TCSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```
Plants in sterile soil have lower total carbon in the pore-water than plants in live soil. Live soil is not different from any other treatment (I think it's the similar to EC and pH, the variance is very large for C and N pots, so the distributions overlap too much to be significant). In general all treatments have decreased TC at high soil moisture with the exception of "N" (no plant, microbe) treatment, which sees increases in TC. This seems odd. Any thoughts?

```{r TC plot, message=F, warning=FALSE, echo=FALSE}
TCpreds <- ggemmeans(TCSoil, terms = c("Soil", "Level"), type = "fixed")

TCpreds$x <- factor(TCpreds$x, c("C", "N", "S", "L"))

# Create Plot

TCplot <- ggplot(data = TCpreds,
                  mapping = aes(group, predicted,
                                group = x, color = x)) +
  geom_point(size = 1.2) +
  geom_line() +
  xlab("Percent of Water Holding Capacity") +
  ylab("Total Carbon (ppm)") +
  scale_x_discrete(labels = c("1" = "30-50", "2" = "55-75", "3" = "80-100")) +
  theme_classic(18)

ggsave(TCplot, filename = "figures/TCSoil.png")

TCplot
```

### Effects of biomass on total carbon

*Note*: only L and S treatments have biomass, so this is a model to compare L and S only.

```{r total carbon and biomass, message = F}

TCSoil2 <- lmer(TC_ppm ~ Soil + scale(BMrat) + Level + 
                  scale(Dmass_tot) + as.factor(batch_TC) +
                 (1|Geno) + (1|table) + (1|dis_table),
                  data = dat)

```

Root to shoot ratio is better than total biomass in the model.

```{r TC Soil biomass diagnostics, echo=F, fig.dim= c(6,8)}
check_model(TCSoil2)
```
looks good to me!

```{r TC Soil biomass summary table, echo=F}
TCSoil2 %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```
Sterile and live soil plants no longer have total carbon values that are distinct from one another. Instead, with each SD increase in biomass ratio (roots are getting longer) the total carbon in the soil is decreasing. So... carbon inputs to the soil are driven by increased aboveground biomass allocation. 

Although we no longer see that there is a difference in live vs. sterile plants. They did differ in their biomass allocation, where sterile plants had greater shoot allocation relative to root allocation than did live soil plants. I do need more context here, because there are at least two reasons why the soil treatment could result in different allocation patterns (1) the plant is healthy and allocating differently and (2) the roots are being attacked by microbes so there is less root relative to shoot in live soil plants. I wouldn't expect this to result in higher total carbon. Maybe I should correct for biomass ratio so that it's allocation given a certain biomass. But that's a lot of fraction going on at once.

### Inorganic Carbon
```{r IC Soil model selection, include=F }


ICSoil1 <- lmer(IC ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_IC),
                data = dat)

ICSoil2 <- lmer(IC ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_IC),
                data = dat)

compare_performance(ICSoil1, ICSoil2, rank = T)

anova(ICSoil1)
```

The best model will include all soil treatments and an interaction with soil and level

```{r echo = F}
dat$Soil <- relevel(factor(dat$Soil), 
                     ref = "C")
```

```{r IC, message = F}

ICSoil <- lmer(IC ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_IC),
                data = dat)
```

*Check the model diagnostics*

```{r IC diagnostics, echo=F}

check_model(ICSoil)
```

```{r IC summary table, echo=F}
ICSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

The S and N treatments have lower IC than the treatment with microbes and plants (L). No other comparisons are significant. IC is something that we expect as a product of weathering- bicarbonates and stuff. Overall, at high soil moisture there is less IC. Perhaps this is because the pore spaces were saturated and it could have limited reaction rates. There is something interesting once more with the treatment, N ( no plants), IC increases quite a bit as soil moisture increases. This suggests that the reaction rates weren't limited under high soil moisture, but for some other reason. 

```{r echo=FALSE}
saveRDS(ICSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/ICSoil.RDS")
```

```{r IC plot2, message=F, echo=FALSE}
ICpreds <- ggemmeans(ICSoil, terms = "Soil", type = "fixed")

ICpreds$x <- factor(ICpreds$x, c("C", "N", "S", "L"))

# Create Plot

ICplot <- ggplot() +
  geom_pointrange(data = ICpreds,
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  xlab("Soil Biota Treatment") +
  ylab("Inorganic Carbon (ppm)") +
  scale_x_discrete(labels = c("C" = "Abiotic \n Control", "N" = "Microbes \nOnly",
                              "S" = "Plant \nOnly", "L" = "Plant & \n Microbes")) +
  theme_classic(18)

ggsave(ICplot, filename = "figures/ICSoil.png",
       height = 6, width =8, units = "in")

ICplot
```


```{r Simulate data from IC model, echo= F, message=F, include=F}
# Step 1: Generate Predicted Data (remove effect of Level) 
pred.funIC <- function(mod) {
  model.matrix(~Soil,
               data = expand.grid(Soil =c("S","C", "L", "N"))) %*%
    fixef(mod)[c(1:4)]
}

#Create cluster within computer to bootstrap in parallel
cl <- makeCluster(detectCores()) 
clusterEvalQ(cl, library(lme4))

#create data frame of model predictions for EC and pH in each soil treatment
ICsims <- bootMer(ICSoil, FUN = pred.funIC,
                nsim = 1000, parallel = "snow", ncpus = detectCores(),cl = cl)

stopCluster(cl = cl)

#Prepare Data for Bartlett Test
ICdraws <- data.frame(ICsims$t)

Soil <- c("S", "C", "L", "N")

names(ICdraws) <- Soil
```

```{r plot the density of the IC sims, echo = F}
ICdraws2 <- pivot_longer(ICdraws, cols = S:N)

densityPlot(ICdraws2$value ~ as.factor(ICdraws2$name),
            legend = list(title = "Soil Treatment"),
            xlab = "Model Estimates of IC")
```
A different way to visualize the model output. This is from the perspective of the average effect of soil moisture (intercept moisture only). The C and L treatments both have soil microbes in common, and they have equal increases in IC relative to the non-microbial treatments. This makes me think that the change in IC is dominated by activity of microbes. However, we see that the  distribution of simulated data for L (microbes and plants) is much tighter, repeating the pattern that we've seen for EC and pH, so it seems that plants don't add to the effect of biota, but they help to regulate the effect of biota. 

### Effects of biomass on inorganic carbon 

*Note*: only L and S treatments have biomass, so this is a model to compare L and S only.

I evaluated model performance including the interaction between soil and level, and using biomass ratio instead of total biomass and below is the top performing model. 

```{r IC biomass, message = F}

ICSoil2 <- lmer(IC ~ Soil + Level + scale(Dmass_tot) + scale(totBM) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_IC),
                data = dat)
```

```{r IC biomass diagnostics, echo=F}

check_model(ICSoil2)
```

```{r IC biomass summary table, echo=F}
ICSoil2 %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Plants + microbes (L) have higher inorganic carbon then just plants alone (S). IC decreases at the highest soil moisture (why?). It seems that as plants get larger, they are associated with higher IC, but this relationship is marginal. 

### Organic Carbon

```{r OC Soil model selection, include=F }

dat$batch_NPOC <- as.factor(dat$batch_NPOC)
contrasts(dat$batch_NPOC) <- contr.sum(3)

OCSoil1 <- lmer(NPOC ~ Soil + Level + scale(Dmass_tot) + batch_NPOC +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)

OCSoil2 <- lmer(NPOC ~ Soil * Level + scale(Dmass_tot) + batch_NPOC +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)
compare_performance(OCSoil1, OCSoil2, rank = T)

anova(OCSoil2)
```

```{r OC, message = F}

OCSoil <- lmer(log(NPOC) ~ Soil + Level + scale(Dmass_tot) + batch_NPOC +
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)
```

*Check the model diagnostics*

```{r OC diagnostics, echo=F}

check_model(OCSoil)
```

```{r OC summary table, echo=F}
OCSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Soil treatment has absolutely no effect on organic carbon. Similar to other analyses, NPOC is lower at the highest soil moisture. This is maybe not surprising because organic carbon is carbon that would not be present/produced in the abiotic treatment (N, as part of B), and would be produced and immediately used in the biotic treatments.

```{r echo=FALSE}
saveRDS(OCSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/OCSoil.RDS")
```
### Effects of biomass on organic carbon 

*Note*: only L and S treatments have biomass, so this is a model to compare L and S only.

I evaluated model performance, and there should be no interaction between soil and level, we should use total biomass.

```{r OC biomass, message = F}

dat$batch_NPOC <- as.factor(dat$batch_NPOC)
contrasts(dat$batch_NPOC) <- contr.sum(3)

OCSoil2 <- lmer(log(NPOC) ~ Soil + Level + scale(Dmass_tot) + scale(totBM) + batch_NPOC + 
                 (1|Geno) + (1|dis_table) + (1|table),
                data = dat)
```

```{r OC biomass diagnostics, echo=F}

check_model(OCSoil2)
```

```{r OC biomass summary table, echo=F}
OCSoil2 %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

The same pattern as before. Also, biomass has no relationship with NPOC. Again, I'm thinking that this is because the NPOC being produced is being used pretty quickly, so we don't see relationships in the pore water.

<a id="summary-two"></a>

### Carbon Summary

Above we evaluated trends in total carbon, inorganic carbon, and organic carbon for all treatments (C,N,S,L) and in relation to biomass (S & L only). 

We see that the treatment that contained microbes and plants (L) had higher amounts of total carbon in the porewater than planted treatments without microbes (S). It is likely that we see no difference between the planted and unplanted treatments for the same reason as that of EC and pH; the st. error seems very high. I can do the post hoc tests later to confirm. We see that for inorganic carbon (another measure of how much the basalt has weathered) that microbes and plants (L) have higher amounts of inorganic carbon than the non-microbial treatments (S and L). This suggests that the weathering is driven more so by the microbes than by the plants, but the plants continue to stabilize the relationship. There are no patterns between treatment and organic carbon. This may be because all the organic carbon is either not being produced (N treatment) or is being used by biota as soon as it is produced because it is bioavailable (C, L, and S). 

Biomass seems to play a role in some of these trends for the L and S treatments. IC increases as biomass increases, and TC increases as shoot ratio increases. 

There is a very consistent trend with water in these models. All measures of carbon decrease at the highest soil moisture level. The only exception is that the abiotic treatmnt (N) had increasing IC with increasing soil moisture. That may help us to describe the role that water plays in weathering in the absence of microbes and plants and suggests that microbes and plants inhibit some components of weathering relative to water alone. 

back to [table of contents](#toc)

<a id="item-four"></a>

## Nitrogen

### Nitrate

```{r Nitrate Soil model selection, include=F }

#Step 1:
NO3Soil1 <- lmer((mu_NO3) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = dat)

NO3Soil2 <- lmer((mu_NO3) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = dat)

compare_performance(NO3Soil1, NO3Soil2, rank = T)
```


```{r echo = F}
dat$Soil <- relevel(factor(dat$Soil), 
                     ref = "C")
```

```{r Nitrate Soil Model, message=F}
NO3Soil <- lmer(log(mu_NO3) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_NO3 >= quantile(mu_NO3, na.rm = T, 0.1)))
```

*Check Model Diagnostics*

```{r Nitrate Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(NO3Soil)
```


```{r Nitrate Model Summary, echo=FALSE}
NO3Soil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

There is absolutely nothing going on here. Neither soil treatment nor soil moisture affect levels of porewater nitrate. I need to go back into the raw data and see if there is anyway I can group the data into batches (If I can see they have a time/date stamp). That may correct for some variation in the data. 

```{r echo=FALSE}
saveRDS(NO3Soil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/NO3Soil.RDS")
```



```{r Nitrate plot, message=F, echo=FALSE}
NO3preds <- ggemmeans(NO3Soil, terms = "Soil", type = "fixed")

NO3preds$x <- factor(NO3preds$x, c("C", "N", "S", "L"))

# Create Plot

NO3plot <- ggplot() +
  geom_pointrange(data = NO3preds,
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  xlab("Soil Biota Treatment") +
  ylab("Nitrate (mg/L)") +
  scale_x_discrete(labels = c("C" = "Abiotic \n Control", "N" = "Microbes \nOnly",
                              "S" = "Plant \nOnly", "L" = "Plant & \n Microbes")) +
  theme_classic(18)

ggsave(NO3plot, filename = "figures/NO3Soil.png",
       height = 6, width =8, units = "in")

NO3plot
```



### Nitrite

Only 1 sample/150 produced a reading for Nitrite. 

### Ammonium 

```{r Ammonium Soil model selection, include=F }

NH4Soil1 <- lmer(log(mu_NH4) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = dat)

NH4Soil2 <- lmer(log(mu_NH4) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = dat)

compare_performance(NH4Soil1, NH4Soil2, rank = T)

```

```{r Ammonium Soil Model, message=F}
NH4Soil <- lmer((mu_NH4) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table)+ (1|batch_anion),
                data = filter(dat, mu_NH4 < 9 & mu_NH4 > 1))
```

*Check Model Diagnostics*

```{r Ammonium Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(NH4Soil)
```


```{r Ammonium Model Summary, echo=FALSE}
NH4Soil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

There is very little happening with ammonium. We see that for the L treatment (plant and microbes), ammonium decreases at the highest soil moisture, and that for the S treatment (plant but no microbes) ammonium increases at the highest soil moisture. So plants, microbes, and soil moisture interact to affect the amount of ammonium in the pore water. 

```{r echo=FALSE}
saveRDS(NH4Soil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/NH4Soil.RDS")
```

[Table of Contents](#toc)

<a id="item-five"

## Cations

Jump to [summary](#summary-three) of Cation models.

### Sodium

```{r Sodium Soil model selection, include=F }

NaSoil1 <- lmer(log(mu_Na) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = dat)

NaSoil2 <- lmer(log(mu_Na) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = dat)

compare_performance(NaSoil1, NaSoil2,rank = T)

```

The best model includes all soil treatments and an interaction between soil and level

```{r Sodium Soil Model, message=F}
NaSoil <- lmer((mu_Na) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = filter(dat, mu_Na < 2000))
```

*Check Model Diagnostics*

```{r Sodium Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(NaSoil)
```


```{r Sodium Model Summary, echo=FALSE}
NaSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Nothing really happening here except for a relationship between sodium and soil moisture. Sodium decreases at the highest soil moisture treatment, except for N in which case it actually increases quite a bit. I think there is something going on between biota and many of the bioavailable substances in the porewater. We see a similar relationship for organic carbon.

```{r echo=FALSE}
saveRDS(NaSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/NaSoil.RDS")
```

```{r Na plot, message=F, echo=FALSE}
Napreds <- ggemmeans(NaSoil, terms = c("Soil", "Level"), type = "fixed")

Napreds$x <- factor(Napreds$x, c("C", "N", "S", "L"))

t <- data.frame(cbind(group = c("1", "2", "3"), Level = c("Low Moisture", "Medium Moisture", "High Moisture")))

t$Level <- factor(t$Level, levels = c("Low Moisture", "Medium Moisture", "High Moisture"))

Napreds <- left_join(Napreds, t, by = "group")

# Create Plot

Naplot <- ggplot(data = Napreds,
                  mapping = aes(group, predicted,
                                group = x, color = x)) +
  geom_point(size = 1.2) +
  geom_line() +
  xlab("Percent of Water Holding Capacity") +
  ylab("Sodium (mg/L)") +
  scale_x_discrete(labels = c("1" = "30-50", "2" = "55-75", "3" = "80-100")) +
  theme_classic(18)

ggsave(Naplot, filename = "figures/NaSoil.png")

Naplot
```

### Calcium

```{r Calcium Soil model selection, warning = F, message = F, include=F }

CaSoil1 <- lmer(log(mu_Ca) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = filter(dat, mu_Ca >= quantile(mu_Ca, na.rm = T, 0.2)))

CaSoil2 <- lmer(log(mu_Ca) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = filter(dat, mu_Ca >= quantile(mu_Ca, na.rm = T, 0.2)))

compare_performance(CaSoil1, CaSoil2, rank = T)

```

The best model only evaluates bare vs planted, and does not include an interaction with microbes. 

Initial diagnostics showed that some of the data were extremely low compared to the rest of the data and causing problems with model fit. 
```{r Calcium Soil Model, message=F}
CaSoil <- lmer(log(mu_Ca) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = filter(dat, mu_Ca >= quantile(mu_Ca, na.rm = T, 0.2)))
```

*Check Model Diagnostics*

```{r Calcium Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(CaSoil)
```


```{r Calcium Model Summary, echo=FALSE}
CaSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Nothing affects the amount of Calcium in the soil.

```{r echo=FALSE}
saveRDS(CaSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/CaSoil.RDS")
```

### Magnesium

```{r Magnesium Soil model selection, warning = F, message = F, include=F }

MgSoil1 <- lmer(log(mu_Mg) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = dat)

MgSoil2 <- lmer(log(mu_Mg) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = dat)

compare_performance(MgSoil1, MgSoil2, rank = T)
```

```{r Magnesium Soil Model, message=F}
MgSoil <- lmer(log(mu_Mg) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = dat)
```

*Check Model Diagnostics*

```{r Magnesium Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(MgSoil)
```


```{r Magnesium Model Summary, echo=FALSE}
MgSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Moisture has no effect on porewater magnesium, however there seems to be an interaction between plants and microbes because the "L" treatment has higher magnesium than the S (plants, no microbes) and C (microbes, no plants) treatment. So magnesium presents a situation in which both parties are necessary to elevate its concentration. Through which processes is magnesium created? Will there be specific plant-associated microbes that we should be on the lookout for in the metaG data?

```{r echo=FALSE}
saveRDS(MgSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/MgSoil.RDS")
```

```{r MG plot, message=F, echo=FALSE}
Mgpreds <- ggemmeans(MgSoil, terms = "Soil", type = "fixed")

Mgpreds$x <- factor(Mgpreds$x, c("C", "N", "S", "L"))

# Create Plot

Mgplot <- ggplot() +
  geom_pointrange(data = Mgpreds,
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  xlab("Soil Biota Treatment") +
  ylab("Magnesium (mg/L)") +
  scale_x_discrete(labels = c("C" = "Abiotic \n Control", "N" = "Microbes \nOnly",
                              "S" = "Plant \nOnly", "L" = "Plant & \n Microbes")) +
  theme_classic(18)

ggsave(Mgplot, filename = "figures/MgSoil.png",
       height = 6, width =8, units = "in")

Mgplot
```

### Potassium

```{r Potassium Soil model selection, warning = F, message = F, include=F }

#Step 1: Which format of treatment is best?
KSoil1 <- lmer(log(mu_K) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = dat)

KSoil2 <- lmer(log(mu_K) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = dat)

compare_performance(KSoil1, KSoil2, rank = T)
```

The best model contains all treatments and includes the interaction

```{r echo = F}
dat$Soil <- relevel(factor(dat$Soil), 
                     ref = "S")
```

```{r Potassium Soil Model, message=F}
KSoil <- lmer(log(mu_K) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = dat)
```



*Check Model Diagnostics*

```{r Potassium Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(KSoil)
```


```{r K Model Summary, echo=FALSE}
KSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

We once again see that trend where potassium seems to peak at intermediate soil moisture with the exception of the abiotic treatment, N, in which potassium increases as soil moisture increases.

The only difference between treatments is that N seems to have lower potassium than S. S is very similar to L and C, and due to their variation, they are not different than S. I don't think there's much to glean from this model, other than the persistent trend that N pots peak at high soil moisture, while the other pots peak at intermediate soil moisture for many variables. 

```{r echo=FALSE}
saveRDS(KSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/KSoil.RDS")
```


```{r K plot, message=F, echo=FALSE}
Kpreds <- ggemmeans(KSoil, terms = c("Soil", "Level" ), type = "fixed")

# Create Plot

Kplot <- ggplot() +
  geom_pointrange(data = Kpreds,
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  facet_wrap(~group,nrow = 3, ncol = 1) + 
  xlab("Soil Biota Treatment") +
  ylab("Potassium (mg/L)") +
  scale_x_discrete(labels = c("C" = "Abiotic \n Control", "N" = "Microbes \nOnly",
                              "S" = "Plant \nOnly", "L" = "Plant & \n Microbes")) +
  theme_classic(18)

ggsave(Kplot, filename = "figures/KSoil.png")

Kplot
```

## Lithium

```{r echo = F}
dat$Soil <- relevel(factor(dat$Soil), 
                     ref = "C")
```

```{r Lithium Soil Model Selection, message=F, echo = F}
LiSoil1 <- lmer(mu_Li ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = filter(dat, mu_Li < 1.5))

LiSoil2 <- lmer(mu_Li ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = filter(dat, mu_Li < 1.5))

compare_performance(LiSoil1, LiSoil2, rank = T)
```
```{r Li model, message=FALSE}
LiSoil <- lmer(mu_Li ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_cation),
                data = filter(dat, mu_Li < 1.5))
```


```{r Lithium Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(LiSoil)
```


```{r Li Model Summary, echo=FALSE}
LiSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

```{r echo=FALSE}
saveRDS(LiSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/LiSoil.RDS")
```

<a id="summary-three"></a>

## Cations Summary

Overall the cations show very few trends. 

The most robust pattern is that Sodium and Potassium (and Inorganic Carbon) concentrations peak at intermediate soil moisture, with the exception of the "N" treatment (microbes, no plants) where concentrations increase as soil moisture increases. Does this tell us something about how biota affect the rates that these things are produced? 

There may be an interaction between plants and microbes regarding the production of Magnesium. We see that Magnesium levels are higher in the L treatment compared to all other treatments. What is the chemical reaction or the biochemical pathways that lead to the production of Magnesium? Are there certain plant-associated microbes or metabolites that we should be looking for that are more common in the "L" treatment compared to other treatments?

[Table of Contents](#toc)

<a id="item-six"></a>

## Anions

Jump to [summary](#summary-four) of anions.

### Fluoride

```{r Fluoride Soil model selection, warning = F, message = F, include=F }

#Step 1: Which format of treatment is best?
FSoil1 <- lmer(log(mu_F) ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_F <= quantile(mu_F, na.rm = T, 0.85)))

FSoil2 <- lmer(log(mu_F) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_F <= quantile(mu_F, na.rm = T, 0.85)))

compare_performance(FSoil1, FSoil2, rank = T)

```

```{r Fluoride Soil Model, message=F}
FSoil <- lmer(log(mu_F) ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_F <= quantile(mu_F, na.rm = T, 0.85)))
```

*Check Model Diagnostics*

```{r Fluoride Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(FSoil)
```


```{r F Model Summary, echo=FALSE}
FSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Fluoride is responsive to soil moisture only. It is stable from low to medium soil moisture and decreases at high soil moisture. Neither plants nor microbes affect Fluoride concentrations in the soil. 

```{r echo=FALSE}
saveRDS(FSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/FSoil.RDS")
```

```{r F plot, message=F, echo=FALSE}
Fpreds <- ggemmeans(FSoil, terms = c("Level" ), type = "fixed")

# Create Plot

Fplot <- ggplot() +
  geom_pointrange(data = (Fpreds),
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  xlab("Percent of Water Holding Capacity") +
  ylab("Fluoride (mg/L)") +
  scale_x_discrete(labels = c("1" = "30-50", "2" = "55-75",
                              "3" = "80-100")) +
  theme_classic(18)

ggsave(Fplot, filename = "figures/FSoil.png",
       height = 6, width =8, units = "in")

Fplot
```


### Bromide

```{r Br Soil model selection, warning = F, message = F, include=F }

#Step 1: Which format of treatment is best?
BrSoil1 <- lmer(mu_Br ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_Br <= quantile(mu_Br, na.rm = T, 0.9)))

BrSoil2 <- lmer(mu_Br ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_Br <= quantile(mu_Br, na.rm = T, 0.9)))

compare_performance(BrSoil1, BrSoil2, rank = T)
```

The best model considers only plant or no plant and has no interaction with soil moisture. I'm filtering out some extremely high values to improve model fit. 


```{r Br Soil Model, message=F}
BrSoil <- lmer(mu_Br ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_Br <= quantile(mu_Br, na.rm = T, 0.9)))
```

*Check Model Diagnostics*

```{r Br Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(BrSoil)
```


```{r Br Model Summary, echo=FALSE}
BrSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Absolutely nothing affects the concentration of Bromide.

```{r echo=FALSE}
saveRDS(BrSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/BrSoil.RDS")
```

### Chloride

```{r Cl Soil model selection, warning = F, message = F, include=F }

#Step 1: Which format of treatment is best?
ClSoil1 <- lmer(mu_Cl ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_Cl <= quantile(mu_Cl, na.rm = T, 0.95)))

ClSoil2 <- lmer(mu_Cl ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_Cl <= quantile(mu_Cl, na.rm = T, 0.95)))

compare_performance(ClSoil1, ClSoil2, rank = T)
```

```{r Cl Soil Model, message=F}
ClSoil <- lmer(mu_Cl ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_Cl <= quantile(mu_Cl, na.rm = T, 0.95)))
```

*Check Model Diagnostics*

```{r Cl Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(ClSoil)
```


```{r Cl Model Summary, echo=FALSE}
ClSoil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```
Chloride is sensitive to soil moisture only and peaks at intermediate soil moisture. 
```{r echo=FALSE}
saveRDS(ClSoil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/ClSoil.RDS")
```

### Phosphate

```{r PO4 Soil model selection, warning = F, message = F, include=F }

densityPlot(dat$mu_PO4) #assess the distribution of the data and how to filter

#Step 1: Which format of treatment is best?
PO4Soil1 <- lmer(mu_PO4 ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_PO4 <= 25))

PO4Soil2 <- lmer(mu_PO4 ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_PO4 <= 25))

compare_performance(PO4Soil1, PO4Soil2, rank = T)
```



```{r echo = F}
dat$Soil <- relevel(factor(dat$Soil), 
                     ref = "C")
```

```{r PO4 Soil Model, message=F}
PO4Soil <- lmer(mu_PO4 ~  Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_PO4 <= 25))
```

*Check Model Diagnostics*

```{r PO4 Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(PO4Soil)
```


```{r PO4 Model Summary, echo=FALSE}
PO4Soil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

The microbe only treatment, N, has the highest phosphate levels, and phosphate only increases as soil moisture increases. With the addition of biota, we see a decrease in phosphate. The presence of plants seems to have a stronger effect on the draw down (use) of phosphate than microbes alone. We can see that the S and L treatments are significantly lower than N, whle the C treatment is only marginally lower. 

```{r echo=FALSE}
saveRDS(PO4Soil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/PO4Soil.RDS")
```

```{r PO4 plot, message=F, echo=FALSE}
PO4preds <- ggemmeans(PO4Soil, terms = "Soil", type = "fixed")

PO4preds$x <- factor(PO4preds$x, c("C", "N", "S", "L"))

# Create Plot

PO4plot <- ggplot() +
  geom_pointrange(data = PO4preds,
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  xlab("Soil Biota Treatment") +
  ylab("Phosphate (mg/L)") +
  scale_x_discrete(labels = c("C" = "Abiotic \n Control", "N" = "Microbes \nOnly",
                              "S" = "Plant \nOnly", "L" = "Plant & \n Microbes")) +
  theme_classic(18)

ggsave(PO4plot, filename = "figures/PO4Soil.png",
       height = 6, width =8, units = "in")

PO4plot
```



### Sulfate

```{r SO4 Soil model selection, warning = F, message = F, include=F }

densityPlot(dat$mu_SO4) #assess the distribution of the data and how to filter

#Step 1: Which format of treatment is best?
SO4Soil1 <- lmer(mu_SO4 ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_SO4 <= 4000))

SO4Soil2 <- lmer(mu_SO4 ~ Soil + Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_SO4 <= 4000))

compare_performance(SO4Soil1, SO4Soil2, rank = T)
```

The best model only compares whether there was a plant and has no interaction

```{r SO4 Soil Model, message=F}
SO4Soil <- lmer(mu_SO4 ~ Soil * Level + scale(Dmass_tot) +
                 (1|Geno) + (1|dis_table) + (1|table) + (1|batch_anion),
                data = filter(dat, mu_SO4 <= 4000))
```

*Check Model Diagnostics*

```{r SO4 Diagnostics, echo=FALSE, fig.dim=c(6,8)}
check_model(SO4Soil)
```

This is the best I can do with model fit. I don't love the two peaks. 

```{r SO4 Model Summary, echo=FALSE}
SO4Soil %>% tidy() %>% filter(!is.na(p.value)) %>% dplyr::select(-c(1:2)) %>% kable(digits = 5)
```

Only soil moisture affects sulfate concentrations. Concentrations increase between low and medium treatments and decrease between medium and high concentrations. 

```{r echo=FALSE}
saveRDS(SO4Soil, "~/Desktop/Alfalfa-Terraformation-GH/Task2A/04_analyses/02_models/Output/SO4Soil.RDS")
```

```{r SO4 plot, message=F, echo=FALSE}
SO4preds <- ggemmeans(SO4Soil, terms = "Level", type = "fixed")

# Create Plot

SO4plot <- ggplot() +
  geom_pointrange(data = SO4preds,
                  mapping = aes(x, predicted,
                                ymin = conf.low, ymax = conf.high),
                  size = 1.2,
                  position = position_dodge(width = 0.2)) +
  xlab("Percent of Water Holding Capacity") +
  ylab("Sulfate (mg/L)") +
  scale_x_discrete(labels = c("1" = "30-50", "2" = "55-75",
                              "3" = "80-100")) +
  theme_classic(18)

ggsave(SO4plot, filename = "figures/SO4Soil.png",
       height = 6, width =8, units = "in")

SO4plot
```

<a id="summary-four"></a>

### Summary of Anions 

This was a tough set of models. Very little is happening in the anions. 

Anions are sensitive to soil moisture and peak at intermediate soil moisture and they are insensitive to biota. This is true for Fluoride, Chloride, and Sulfate. Nothing happens with Bromide. 

Models with Phosphate suggest that treatments containing biota have lower phosphate than the abiotic treatment. 

[Table of Contents](#toc)

<a id="item-seven"></a>

## PCA

```{r Prep the PCA data, echo=FALSE, include=FALSE}

#fix this step here, SO4 is selected out
dat1 <- dat %>% dplyr::select(1,9,11,22:27,29:36, 38, 40, 42,43) 

colSums(is.na(dat1))
#remove NO2, PO4, NH4

dat2 <- dat1 %>% dplyr::select(!c(mu_NO2, mu_PO4, mu_NH4)) %>%
  filter(!is.na(mu_F), !is.na(mu_Cl), !is.na(mu_SO4),
         !is.na(pH), !is.na(EC), !is.na(mu_Na), !is.na(mu_K),
         !is.na(mu_Mg), !is.na(mu_Ca), !is.na(TC_ppm), !is.na(IC), !is.na(mu_Br)
         )

colSums(is.na(dat2)) 

dat3 <- dat2 %>% dplyr::select(!c(pot, Soil, Level)) #now only numbers for PCA

#with this level of keeping variables/filtering we can build a PCA from 85 observations
```

```{r make PCA and describe dimensions, echo=FALSE, include=FALSE}
pwGeo_pca <- PCA(dat3)
```

```{r plot PCA}
pWGeochem <- fviz_pca_biplot(pwGeo_pca, 
                col.ind = as.factor(dat2$Level), palette = "jco", 
                addEllipses = T, ellipse.level = 0.95, label = "var", repel = TRUE,
                legend.title = "Soil Moisture Treatment") +
  theme_classic(12)

pWGeochem
```

So... not much going on here. There's no separation of the different soil treatments based on the 11 porewater geochemistry variables that I included. I wonder what this would look like if the plants had been larger! The PCA includes 11 variables shared between 115 observations (out of a maximum of 245). 

Previously it was 85/97, so number of samples analyzed has improved with improved geochemistry

[Table of Contents](#toc)